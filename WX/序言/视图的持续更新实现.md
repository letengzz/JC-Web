# 视图的持续更新实现

​	视图的持续更新简单来说它是通过`setData`实现的。

在小程序里面 setData在底层 也是通过evaluateJavascript方法实现的 在程序里面视图层和逻辑层的数据传输

实际上都是通过底层的WeixinJSBridge通过原生的evaluateJavascript方法实现的

setData要求更新的数据 首先会将这个数据转换为字符串 接着将这个字符串与代码拼接成一个JavaScript脚本 

最后呢把拼接的内容传给evaluateJavascript的原生方法 然后去执行 

小程序在视图更新上 也做了一些虚拟DOM上的优化 所以说从数据到达视图层的更新并不是实时进行的

使用setData可能会遇到那些问题

从前面我们可以看出 由于视图线程和逻辑线程分属两个线程 两个线程之间通过前置的setData方法

驱动的数据交换 还要通过WeixinJSBridge进行中转 这个中转的效率是极其低下的 所以有时候安卓的小程序用户

在进行界面滑动时会感到页面卡顿 这是因为视图线程一直在努力进行渲染 逻辑层发来的更新请求被阻塞了

当这种阻塞达到200毫秒以上时 试图渲染便会卡顿 机器性能越差 卡顿越明显

卡顿不仅跟更新的频率有关 跟更新的数据量也有关系

当使用setData更新大列表数据或者更新一个Size很大的图片时也容易产生卡顿

在iOS系统上 小程序的页面是由多个WKWebView组成的 系统内存紧张时

一部分WKWebView会被系统回收掉 也就是说曾经打开的小程序页面 将会退出历史记录

这些页面我们无法回退的

![image-20220501181347554](D:/Data/typora/photo/image-20220501181347554.png)